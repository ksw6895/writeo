# EWML User Guide (Comprehensive)

External Working Memory Language (EWML) — 논증과 의사결정을 위해 “외부 작업 기억”을 구조화하는 초경량 표기입니다. 이 가이드는 EWML의 철학, 마인드셋, 문법/메타, 계산 규칙, 활용 분야와 베스트 프랙티스를 한눈에 제공합니다.

- 참고 소스: `src/ewml/parser.ts`, `src/ewml/engine.ts`, `public/demo.ewml`
- 실행/패드: `npm run dev` 후 `/pad.html` (README 참고)


## 철학 (Why EWML?)
- 가벼운 형식화: 긴 산문 대신 “한 줄 한 주장/근거”로 외부화해 인지부하를 낮춥니다.
- 점진적 엄밀성: 처음엔 거칠게(H, E±, D/T/C) 쓰고, 필요 시 메타(@p/@lo/@LR/@grade/@kappa/@ref 등)로 정밀화합니다.
- 투명한 업데이트: 베이즈적 직관(우도비 LR, logit 누적)을 통해 가설의 사전→사후 변화를 일관되게 기록합니다.
- 출처/시간성: `@src`, `@time`, `M:`(문서 메타)로 근거의 맥락과 최신성을 남깁니다.
- 도구 친화성: 단순한 라인 기반 파싱으로 UI(Outline/Graph)와 자동 점검(린트)을 쉽게 붙입니다.


## 마인드셋 (How to think in EWML)
- 원자화: 각 줄은 하나의 역할과 하나의 핵심 주장/근거만 담습니다.
- 연결: 모든 근거(E±)는 항상 관련 가설(Hn)을 `@ref=Hn`으로 명시합니다. 연결 없는 근거는 무용합니다.
- 보수적 업데이트: LR(또는 grade)을 과대추정하지 말고, 상관된 근거엔 `@kappa<1`로 가중치를 낮춥니다.
- 캘리브레이션: `@p`(또는 `@lo`)는 대략적이라도 일관되게. 등급→LR 매핑을 팀 합의로 유지합니다.
- 추적 가능성: `R:`(이유/관계), `D:`(결정), `T:`(검증/할 일), `C:`(주석)로 생각의 궤적을 남깁니다.
- 현실주의: 독립성 가정, LR 주관성 등 한계를 인지하고, 과신 대신 반복 갱신을 전제로 씁니다.


## 언어 개요 (Roles)
- `H` Hypothesis: 가설. 선택적으로 라벨 `H1/H2...` 자동 부여. `@p` 또는 `@lo`로 사전 확률 지정 권장.
- `E+` Evidence for: 지지 근거. `@ref=H1` 등으로 연결. `@LR>1` 또는 `@grade=weak+/...` 필요.
- `E-` Evidence against: 반증 근거. `@ref=H1` 등으로 연결. `@LR<1` 또는 `@grade=weak-/...` 필요.
- `R` Rationale/Relation: 추론의 설명, 변수 관계 메모. 계산엔 직접 미반영(서술적).
- `C` Comment: 자유 주석. 계산 미반영.
- `D` Decision: 임계 기준을 언급해 행동 기준을 명시. 예: `if p(H1) ≥ 0.6 => X`.
- `T` Task/Test: 실행/검증 항목. `@time`, `@outcome` 등 기록.
- `M` Meta: 문서 수준 메타. `doc`, `ver`, `author`, `time` 등.

각 라인은 `역할: 내용 @meta1=..., @meta2=...` 형태입니다. 파서는 라인 내 “첫 번째 `@`”를 기준으로 본문과 메타를 구분합니다.


## 메타 키(표준)
- 확률 관련: `@p`(0~1), `@lo`(logit). 둘 중 하나만 적어도 자동 동기화됩니다.
- 근거 강도: `@LR`(>0), 또는 `@grade`(사전 정의된 등급).
- 연결: `@ref=H1,H2` 등. 콤마/세미콜론 구분 모두 허용.
- 가중치: `@kappa`(기본 1.0). 상관/품질 저하를 감안해 0~1 사이로 완화.
- 출처/시간: `@src`, `@time`(ISO 권장).
- 자유 메타: `@p, @lo, @LR, @grade, @ref, @kappa, @src, @time` 외 키도 허용(문서/팀 규칙에 따름).

등급→LR 매핑(기본값은 엔진 내 상수):
- very-strong+ 10 | strong+ 5 | moderate+ 3 | weak+ 1.5 | neutral 1
- weak- 1/1.5 | moderate- 1/3 | strong- 1/5 | very-strong- 1/10


## 계산 규칙 (Bayes-lite)
- 로짓/시그모이드: `lo = ln(p/(1-p))`, `p = 1/(1+e^{-lo})`.
- 업데이트: 각 H에 대해 `lo_post = lo_prior + Σ κ·ln(LR)`.
  - `κ`는 `@kappa`(기본 1.0), `LR`은 `@LR` 또는 등급→LR 매핑으로 획득.
  - `E+`/`E-` 구분은 LR 자체 부호가 아니라, 사용 지침(린트)에서 방향 일관성을 검증합니다.
- 린트(일부):
  - H에 prior 누락 시 기본 `lo=0 (p=0.5)`로 가정하고 경고.
  - E±에 `@ref` 없으면 경고, 계산 제외.
  - `E-`인데 `LR≥1` 또는 `E+`인데 `LR≤1`이면 권장 위반 경고.


## 문법 규칙 요약
- 역할 토큰은 대소문자 허용하나 저장 시 자동 정규화(H, E+, E-, R, C, D, T, M).
- `H:` 뒤 라벨이 없으면 자동으로 `H1, H2...` 부여.
- 메타는 콤마로 구분. `key=value` 또는 `@key:value` 모두 허용. 플래그형(`@draft`)도 가능.
- `@ref`는 배열로 정규화되며, `H1;H2` 또는 `H1,H2` 등 혼용 가능.


## 빠른 시작 (Pad)
1) 가설 선언

```
H: PE 의심 환자 @p=0.02
```

2) 근거 연결 (지지/반증)

```
E+: 빈맥 @ref=H1 @grade=weak+
E-: D-dimer(-) @ref=H1 @grade=strong-
```

3) 결정 기준 / 작업 기록

```
D: if p(H1) < 0.01 => CTPA 생략
T: 결과 확인 @time=2025-08-17
```

4) 그래프/아웃라인 확인: H의 prior→posterior, Σ ln(LR), 근거-가설 연결을 시각적으로 검토합니다.

5) 린트 해결: `@ref` 누락, LR 방향성 위반, prior 누락 등을 정리합니다.

샘플: `public/demo.ewml`를 Editor에서 “샘플 불러오기”로 확인하세요.


## 예제 (의료 — `demo.ewml`)
```
M: doc="Demo-PE-Case"; ver=0.1; author=각하; time=2025-08-16
H1: PE 의심 환자 @p=0.02
E+: 빈맥 @ref=H1 @grade=weak+
E-: D-dimer(-) @ref=H1 @grade=strong-
R:  lo(H1) <<+>> ln(LR 빈맥) + ln(LR D-dimer)
D:  if p(H1) < 0.01 => CTPA 생략
T:  결과 확인 후 @outcome=false @time=2025-08-17
```
- `H1` prior 0.02에서, `weak+`/`strong-` 근거가 ln(LR)로 누적되어 posterior가 업데이트됩니다.
- `R:`은 사람이 읽는 설명으로 계산엔 직접 포함되지 않습니다.


## 다른 도메인 예시
- 제품/실험:
```
H: 기능 X 출시가 전환율 개선 @p=0.4
E+: A/B 실험 uplift 3%p @ref=H1 @LR=2.5 @src=https://...
E-: 유지보수 비용 급증 전망 @ref=H1 @grade=moderate-
D: if p(H1) ≥ 0.6 => 점진적 롤아웃
T: 2주 추적 측정 @time=2025-09-01
```
- 보안/사건 대응, 연구 리딩 노트, 저널리즘 조사, 법정 논증, 설계 의사결정 기록 등에도 적합합니다.


## 쓰기 좋은 분야
- 가설-근거-결정의 루프가 반복되는 모든 지식 작업
- 독립 근거가 여럿 모이며, 경과에 따라 업데이트가 필요한 상황
- 설명 가능성과 추적 가능성이 중요한 팀 협업 맥락


## 특장점
- 단순성: 줄 단위 표기, 진입 장벽 낮음. 편집기/버전관리 친화적.
- 명시적 연결: `@ref`로 근거-가설 링크가 드러나고, 그래프/아웃라인으로 즉시 확인 가능.
- 수치/서술의 공존: `@p/@lo/@LR`로 수치화하면서 `R/C/D/T/M`로 맥락·결정·작업도 함께 기록.
- 자동 점검: 린트로 흔한 실수를 초기에 발견.
- 확장성: 메타 키 확장 용이, 도메인별 규약 추가 가능.


## 한계와 주의
- 독립성 가정: Σ ln(LR)은 근거 독립을 암묵 가정. 상관 시 `@kappa`로 완화하거나 합리화(`R:`)를 남기세요.
- LR 추정의 주관성: 등급/수치화는 팀 캘리브레이션과 사후 검증이 필요.
- 순환 의존: 현재 엔진은 순환 참조 검출을 보수적으로 생략(MVP). 자기지시적 패턴은 피하세요.
- 표기 규칙: 본문과 메타는 “첫 `@`”로 분리됩니다. 본문에 `@`가 필요한 경우 이스케이프/서술 방식 조정이 필요합니다.
- 법적/윤리적 이슈: 민감 데이터 출처(`@src`) 관리와 접근통제는 별도 정책으로 관리하세요.


## 베스트 프랙티스 체크리스트
- H마다 prior를 명시 (`@p` 또는 `@lo`).
- 모든 E±에 `@ref` 지정, `@LR` 또는 `@grade` 중 하나는 필수.
- 상관된 근거엔 `@kappa<1`로 보수화.
- 결정 기준 `D:`는 명확한 임계와 행동을 포함.
- `T:`로 실행/검증 루프를 닫고 `@outcome`/`@time`을 남김.
- 린트가 뜨지 않도록 주기적 정리.


## 치트시트
- 역할: `H, E+, E-, R, C, D, T, M`
- 메타: `@p, @lo, @LR, @grade, @ref, @kappa, @src, @time`
- 규칙: `lo_post = lo_prior + Σ κ·ln(LR)`; `p = 1/(1+e^{-lo})`
- 등급→LR: `very-strong+ 10 | strong+ 5 | moderate+ 3 | weak+ 1.5 | neutral 1 | weak- 1/1.5 | moderate- 1/3 | strong- 1/5 | very-strong- 1/10`


## FAQ
- Q. `@p`와 `@lo`를 둘 다 적어야 하나요?
  - A. 하나만 적으면 나머지는 자동 계산됩니다. 둘 다 있으면 파서가 일관된 값으로 동기화합니다.
- Q. `E-`에 `LR>1`을 넣으면 어떻게 되나요?
  - A. 계산상 ln(LR)은 그대로 누적되지만, 린트가 방향성 위반 경고를 냅니다. 의미상 `E-`에는 `LR<1`을 쓰세요.
- Q. 근거에 `@ref`를 여러 개 달 수 있나요?
  - A. 가능하며, 콤마/세미콜론으로 구분합니다. 그래프에 각 가설로 에지가 생성됩니다.
- Q. 등급 대신 직접 `@LR`을 써도 되나요?
  - A. 네. 등급은 팀 공통 캘리브레이션을 돕기 위한 편의입니다.


## 내부 구현 힌트
- 파싱: `src/ewml/parser.ts` — 역할 토큰 정규화, 메타 파싱, `@p`/`@lo` 동기화, 등급→LR 매핑.
- 계산: `src/ewml/engine.ts` — H별 prior 추출, `@ref`된 E±의 `ln(LR)·kappa` 합산, posterior 계산, 린트.
- UI: Outline/Graph/Console/Learn 패널을 통해 문서 상태를 다각적으로 확인.

필요 시 조직/도메인에 맞춰 메타 규약과 등급 매핑을 조정하고, 린트 규칙을 강화해 운영 표준으로 확장하세요.

